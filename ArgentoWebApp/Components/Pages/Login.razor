@page "/login"
@inject HttpClient Http
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Authentication
@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims

<h3>Login</h3>

<div>
    <input @bind="username" placeholder="Username" />
</div>
<div>
    <input type="password" @bind="password" placeholder="Password" />
</div>
<div>
    <button @onclick="PerformLogin">Login</button>
</div>

@code {
    private string username = "";
    private string password = "";

    private async Task PerformLogin()
    {
        var response = await Http.PostAsJsonAsync("https://localhost:5007/api/auth/login", new { Username = username, Password = password });

        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<LoginResult>();

            var handler = new JwtSecurityTokenHandler();
            var jwt = handler.ReadJwtToken(result!.token);

            var claims = jwt.Claims;
            var identity = new ClaimsIdentity(claims, "Cookies");
            var principal = new ClaimsPrincipal(identity);

            await HttpContextAccessor.HttpContext!.SignInAsync("Cookies", principal);

            Navigation.NavigateTo("/");
        }
        else
        {
            // show error
        }
    }

    public class LoginResult
    {
        public string token { get; set; } = string.Empty;
    }
}
